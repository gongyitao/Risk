<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能工作台 - 策略E+ 智能化系统</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body class="workspace-page">
    <!-- 顶部工具栏 -->
    <header class="workspace-header">
        <div class="workspace-header-left">
            <a href="index.html" class="back-btn">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M13 4L7 10L13 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                返回
            </a>
            <div class="workspace-title">智能工作台</div>
            <a href="projects.html" class="icon-btn" title="项目管理" style="margin-left: var(--spacing-md);">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <rect x="2" y="3" width="16" height="14" rx="2" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M6 3V1M14 3V1M2 7H18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
            </a>
        </div>
        <div class="workspace-header-center">
            <div class="module-selector">
                <button class="module-btn active" data-module="operation">
                    <span class="module-btn-icon">📊</span>
                    数据助手
                </button>
                <button class="module-btn" data-module="insight">
                    <span class="module-btn-icon">🔍</span>
                    策略挖掘
                </button>
                <button class="module-btn" data-module="reporting">
                    <span class="module-btn-icon">📄</span>
                    报告生成
                </button>
                <button class="module-btn" data-module="knowledge">
                    <span class="module-btn-icon">📚</span>
                    知识库
                </button>
            </div>
        </div>
        <div class="workspace-header-right">
            <button class="icon-btn" title="新建会话" onclick="newSession()">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M10 4V16M4 10H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <button class="icon-btn" title="保存" onclick="saveSession()">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M16 18H4C3.44772 18 3 17.5523 3 17V3C3 2.44772 3.44772 2 4 2H12L17 7V17C17 17.5523 16.5523 18 16 18Z" stroke="currentColor" stroke-width="2"/>
                    <path d="M13 2V7H17M6 11H14M6 14H14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <button class="icon-btn" title="导出" onclick="exportResults()">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M10 3V13M10 13L6 9M10 13L14 9M3 17H17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
        </div>
    </header>

    <!-- 主工作区：左右分栏 -->
    <main class="workspace-main">
        <!-- 左侧：对话交互区 -->
        <div class="chat-panel">
            <div class="chat-messages" id="chatMessages">
                <!-- 欢迎消息 -->
                <div class="message system-message">
                    <div class="message-avatar">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="10" fill="url(#ai-gradient)"/>
                            <path d="M8 10H10M14 10H16M9 14C9 14 10 16 12 16C14 16 15 14 15 14" stroke="white" stroke-width="2" stroke-linecap="round"/>
                            <defs>
                                <linearGradient id="ai-gradient" x1="2" y1="2" x2="22" y2="22">
                                    <stop offset="0%" stop-color="#667eea"/>
                                    <stop offset="100%" stop-color="#764ba2"/>
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">策略E+ AI助手</span>
                            <span class="message-time">刚刚</span>
                        </div>
                        <div class="message-text">
                            <p>👋 您好！我是策略E+ AI助手，可以帮您：</p>
                            <ul>
                                <li>📊 使用自然语言查询和分析数据</li>
                                <li>🔍 自动挖掘风险特征和策略规则</li>
                                <li>📄 生成专业的策略分析报告</li>
                                <li>📚 查询风控制度和历史策略</li>
                            </ul>
                            <p>请直接输入您的需求，例如："帮我查询近30天的逾期用户特征"</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 输入框 -->
            <div class="chat-input-container">
                <!-- 样本条件选择器 -->
                <div class="sample-selector" id="sampleSelector" style="display: none;">
                    <div class="selector-header">
                        <h4>📋 样本条件快速选择器</h4>
                        <button class="close-selector" onclick="closeSampleSelector()">×</button>
                    </div>
                    <div class="selector-content">
                        <div class="selector-section">
                            <h5>👤 用户基础信息</h5>
                            <div class="condition-group">
                                <label class="condition-item">
                                    <input type="checkbox" name="condition" value="age">
                                    <span>年龄</span>
                                    <select class="condition-operator">
                                        <option value="between">在...之间</option>
                                        <option value="lt">小于</option>
                                        <option value="gt">大于</option>
                                    </select>
                                    <input type="text" class="condition-value" placeholder="例如: 18-35">
                                </label>
                                <label class="condition-item">
                                    <input type="checkbox" name="condition" value="gender">
                                    <span>性别</span>
                                    <select class="condition-value">
                                        <option value="">请选择</option>
                                        <option value="male">男</option>
                                        <option value="female">女</option>
                                    </select>
                                </label>
                                <label class="condition-item">
                                    <input type="checkbox" name="condition" value="income">
                                    <span>月收入</span>
                                    <select class="condition-operator">
                                        <option value="between">在...之间</option>
                                        <option value="lt">小于</option>
                                        <option value="gt">大于</option>
                                    </select>
                                    <input type="text" class="condition-value" placeholder="例如: 5000-10000">
                                </label>
                                <label class="condition-item">
                                    <input type="checkbox" name="condition" value="city">
                                    <span>所在城市</span>
                                    <select class="condition-value" multiple size="3">
                                        <option value="beijing">北京</option>
                                        <option value="shanghai">上海</option>
                                        <option value="guangzhou">广州</option>
                                        <option value="shenzhen">深圳</option>
                                        <option value="other">其他</option>
                                    </select>
                                </label>
                            </div>
                        </div>
                        
                        <div class="selector-section">
                            <h5>💳 信贷行为</h5>
                            <div class="condition-group">
                                <label class="condition-item">
                                    <input type="checkbox" name="condition" value="entry_time">
                                    <span>入网时长</span>
                                    <select class="condition-operator">
                                        <option value="gt">大于</option>
                                        <option value="lt">小于</option>
                                        <option value="between">在...之间</option>
                                    </select>
                                    <input type="text" class="condition-value" placeholder="例如: 6个月">
                                </label>
                                <label class="condition-item">
                                    <input type="checkbox" name="condition" value="overdue">
                                    <span>逾期记录</span>
                                    <select class="condition-value">
                                        <option value="">请选择</option>
                                        <option value="none">无逾期</option>
                                        <option value="has">有逾期</option>
                                        <option value="serious">严重逾期(>30天)</option>
                                    </select>
                                </label>
                                <label class="condition-item">
                                    <input type="checkbox" name="condition" value="loan_amount">
                                    <span>借款金额</span>
                                    <select class="condition-operator">
                                        <option value="between">在...之间</option>
                                        <option value="lt">小于</option>
                                        <option value="gt">大于</option>
                                    </select>
                                    <input type="text" class="condition-value" placeholder="例如: 10000-50000">
                                </label>
                                <label class="condition-item">
                                    <input type="checkbox" name="condition" value="loan_count">
                                    <span>借款次数</span>
                                    <select class="condition-operator">
                                        <option value="eq">等于</option>
                                        <option value="lt">小于</option>
                                        <option value="gt">大于</option>
                                    </select>
                                    <input type="text" class="condition-value" placeholder="例如: 3">
                                </label>
                            </div>
                        </div>
                        
                        <div class="selector-section">
                            <h5>📅 时间范围</h5>
                            <div class="condition-group">
                                <label class="condition-item">
                                    <input type="checkbox" name="condition" value="time_range">
                                    <span>申请时间</span>
                                    <select class="condition-operator">
                                        <option value="recent">最近</option>
                                        <option value="custom">自定义</option>
                                    </select>
                                    <input type="text" class="condition-value" placeholder="例如: 30天">
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="selector-footer">
                        <button class="btn-secondary btn-small" onclick="resetConditions()">
                            <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                                <path d="M12 7C12 9.76142 9.76142 12 7 12C4.23858 12 2 9.76142 2 7C2 4.23858 4.23858 2 7 2C8.8 2 10.4 3 11.2 4.5M11.2 4.5V2M11.2 4.5H9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                            重置
                        </button>
                        <button class="btn-primary btn-small" onclick="applyConditions()">
                            <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                                <path d="M2 7L5 10L12 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            应用条件 (<span id="conditionCount">0</span>)
                        </button>
                    </div>
                </div>
                
                <!-- 智能建议 -->
                <div class="quick-suggestions" id="quickSuggestions">
                    <button class="suggestion-btn" onclick="sendPredefinedMessage('查询近30天内逾期超过7天的用户，分析其年龄、收入、入网时长等特征')">
                        查询逾期用户特征分析
                    </button>
                    <button class="suggestion-btn" onclick="sendPredefinedMessage('帮我挖掘高风险客群，重点关注年龄、收入、借款金额的组合特征')">
                        挖掘高风险客群特征
                    </button>
                    <button class="suggestion-btn" onclick="sendPredefinedMessage('生成上周策略回测报告，对比新旧策略的通过率和坏账率')">
                        生成策略回测报告
                    </button>
                    <button class="suggestion-btn" onclick="sendPredefinedMessage('查询民族字段是否可以作为拒绝规则使用')">
                        咨询合规问题
                    </button>
                </div>

                <!-- 状态显示 -->
                <div class="ai-status" id="aiStatus" style="display: none;">
                    <div class="status-indicator">
                        <div class="spinner"></div>
                        <span class="status-text">AI正在处理中...</span>
                    </div>
                </div>

                <div class="chat-input">
                    <button class="selector-toggle-btn" onclick="toggleSampleSelector()" title="打开样本条件选择器">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                            <rect x="2" y="2" width="14" height="14" rx="2" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M6 6H12M6 9H12M6 12H9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                    </button>
                    <textarea 
                        id="messageInput" 
                        placeholder="输入您的需求，或点击左侧按钮使用条件选择器..." 
                        rows="1"
                        onkeydown="handleInputKeydown(event)"
                    ></textarea>
                    <button class="send-btn" onclick="sendMessage()">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path d="M18 2L9 11M18 2L12 18L9 11M18 2L2 8L9 11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- 右侧：动态工作台 -->
        <div class="canvas-panel">
            <div class="canvas-toolbar">
                <div class="canvas-tabs">
                    <button class="canvas-tab active" data-view="welcome" onclick="switchCanvasView('welcome')">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M8 2L14 5V10C14 12.5 11 14 8 15C5 14 2 12.5 2 10V5L8 2Z" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                        概览
                    </button>
                    <button class="canvas-tab" data-view="code" onclick="switchCanvasView('code')" style="display:none;">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M5 4L2 8L5 12M11 4L14 8L11 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        代码
                    </button>
                    <button class="canvas-tab" data-view="chart" onclick="switchCanvasView('chart')" style="display:none;">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M2 12L6 8L9 11L14 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        图表
                    </button>
                    <button class="canvas-tab" data-view="report" onclick="switchCanvasView('report')" style="display:none;">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <rect x="3" y="2" width="10" height="12" rx="1" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M5 5H11M5 8H11M5 11H9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        报告
                    </button>
                </div>
                <div class="canvas-actions">
                    <button class="icon-btn-small" title="刷新">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M14 8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8C2 4.68629 4.68629 2 8 2C10.3 2 12.3 3.3 13.3 5.2M13.3 5.2V2M13.3 5.2H10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                    </button>
                    <button class="icon-btn-small" title="全屏">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M10 2H14V6M6 14H2V10M14 2L9 7M2 14L7 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="canvas-content">
                <!-- 欢迎视图 -->
                <div class="canvas-view active" id="welcomeView">
                    <div class="welcome-content">
                        <div class="welcome-icon">
                            <svg width="80" height="80" viewBox="0 0 80 80" fill="none">
                                <circle cx="40" cy="40" r="38" stroke="url(#welcome-gradient)" stroke-width="4"/>
                                <path d="M25 35L35 45L55 25" stroke="url(#welcome-gradient)" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                                <defs>
                                    <linearGradient id="welcome-gradient" x1="0" y1="0" x2="80" y2="80">
                                        <stop offset="0%" stop-color="#667eea"/>
                                        <stop offset="100%" stop-color="#764ba2"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                        </div>
                        <h3>智能工作台已就绪</h3>
                        <p>在左侧对话框输入您的需求，AI将自动生成代码、图表和报告</p>
                        <div class="welcome-stats">
                            <div class="welcome-stat">
                                <div class="stat-number">1,234</div>
                                <div class="stat-label">累计分析次数</div>
                            </div>
                            <div class="welcome-stat">
                                <div class="stat-number">85%</div>
                                <div class="stat-label">代码准确率</div>
                            </div>
                            <div class="welcome-stat">
                                <div class="stat-number">30min</div>
                                <div class="stat-label">平均耗时</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 代码视图 -->
                <div class="canvas-view" id="codeView">
                    <div class="code-editor">
                        <div class="code-header">
                            <div class="code-language">SQL</div>
                            <button class="btn-secondary btn-small" onclick="copyCode()">
                                <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                                    <rect x="4" y="4" width="8" height="8" rx="1" stroke="currentColor" stroke-width="1.5"/>
                                    <path d="M2 10V2H10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                </svg>
                                复制代码
                            </button>
                        </div>
                        <pre id="codeContent"><code>-- 代码将在这里显示</code></pre>
                    </div>
                    <div class="code-result">
                        <div class="result-header">
                            <h4>
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                                    <path d="M8 2L14 5V10C14 12.5 11 14 8 15C5 14 2 12.5 2 10V5L8 2Z" stroke="#f59e0b" stroke-width="1.5"/>
                                </svg>
                                沙箱测试结果 (LIMIT 100)
                            </h4>
                            <span class="result-status success">✓ 预检通过</span>
                        </div>
                        <div class="sandbox-notice">
                            <p><strong>📌 沙箱机制说明：</strong></p>
                            <p>为保证代码质量和系统安全，已在沙箱环境中执行<strong>LIMIT 100</strong>预检测试。</p>
                            <ul style="margin: 8px 0; padding-left: 20px; font-size: 13px; line-height: 1.8;">
                                <li>✓ 语法检查：SQL语法正确</li>
                                <li>✓ 权限检查：数据访问权限正常</li>
                                <li>✓ 质量检查：数据缺失率在可接受范围内</li>
                            </ul>
                            <div style="display: flex; gap: 12px; margin-top: 12px;">
                                <button class="btn-primary btn-small" onclick="executeFullData()">
                                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                                        <path d="M7 2V12M7 12L4 9M7 12L10 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    执行全量数据
                                </button>
                                <button class="btn-secondary btn-small" onclick="showDataQualityReport()">
                                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                                        <circle cx="7" cy="7" r="5" stroke="currentColor" stroke-width="1.5"/>
                                        <path d="M7 5V7M7 9H7.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                    </svg>
                                    查看质量报告
                                </button>
                            </div>
                        </div>
                        <div class="result-stats">
                            <div class="result-stat">
                                <span class="stat-label">沙箱行数</span>
                                <span class="stat-value" id="resultRows">0</span>
                            </div>
                            <div class="result-stat">
                                <span class="stat-label">执行时间</span>
                                <span class="stat-value" id="resultTime">0ms</span>
                            </div>
                            <div class="result-stat">
                                <span class="stat-label">缺失率</span>
                                <span class="stat-value" id="resultMissing">0%</span>
                            </div>
                        </div>
                        <div class="result-table" id="resultTable">
                            <!-- 数据表格将在这里显示 -->
                        </div>
                    </div>
                </div>

                <!-- 图表视图 -->
                <div class="canvas-view" id="chartView">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h4 id="chartTitle">特征分析图表</h4>
                            <div class="chart-controls">
                                <select id="chartTypeSelector" onchange="updateChartType()">
                                    <option value="bar">柱状图</option>
                                    <option value="line">折线图</option>
                                    <option value="binning">分箱分析</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="mainChart"></canvas>
                        </div>
                        <div class="chart-stats">
                            <div class="stat-card">
                                <div class="stat-card-label">IV值</div>
                                <div class="stat-card-value" id="ivValue">0.324</div>
                                <div class="stat-card-desc">信息价值较高</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-label">KS值</div>
                                <div class="stat-card-value" id="ksValue">0.287</div>
                                <div class="stat-card-desc">区分度良好</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-label">Gini系数</div>
                                <div class="stat-card-value" id="giniValue">0.453</div>
                                <div class="stat-card-desc">模型效果优秀</div>
                            </div>
                        </div>
                    </div>
                    <!-- 交互式分箱调整 -->
                    <div class="binning-panel" id="binningPanel" style="display: none;">
                        <div class="binning-header">
                            <h4>交互式分箱调整</h4>
                            <p>拖动滑块调整分箱切点，系统将实时重算风险指标</p>
                        </div>
                        <div class="binning-controls" id="binningControls">
                            <!-- 分箱滑块将动态生成 -->
                        </div>
                        <button class="btn-primary btn-small" onclick="applyBinning()">应用分箱</button>
                    </div>
                </div>

                <!-- 报告视图 -->
                <div class="canvas-view" id="reportView">
                    <div class="report-container">
                        <div class="report-header">
                            <h3 id="reportTitle">策略分析报告</h3>
                            <div class="report-meta">
                                <span id="reportDate">2026-01-14</span>
                                <span class="report-author">策略分析师</span>
                            </div>
                        </div>
                        <div class="report-content" id="reportContent">
                            <!-- 报告内容将在这里动态生成 -->
                        </div>
                        <div class="report-actions">
                            <button class="btn-secondary" onclick="downloadReport('word')">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <path d="M8 2V10M8 10L5 7M8 10L11 7M3 14H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                </svg>
                                导出Word
                            </button>
                            <button class="btn-secondary" onclick="downloadReport('pdf')">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <path d="M8 2V10M8 10L5 7M8 10L11 7M3 14H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                </svg>
                                导出PDF
                            </button>
                            <button class="btn-secondary" onclick="downloadReport('ppt')">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <path d="M8 2V10M8 10L5 7M8 10L11 7M3 14H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                </svg>
                                导出PPT
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="assets/js/workspace.js"></script>
</body>
</html>
