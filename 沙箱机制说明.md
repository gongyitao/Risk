# 沙箱机制说明

## 🎯 您的理解完全正确！

您提到的问题理解得非常准确：

> "代码页面下面的执行结果，是脚本生成后的测试结果，即limit=100的数据，当对话窗口提示下一步，才会进入下一个环节。"

**答案：是的！这正是PRD中设计的"沙箱机制"和"智能数据预检"功能。**

---

## 📋 沙箱机制工作流程

### 完整流程图

```
用户输入需求
    ↓
AI生成SQL代码
    ↓
┌─────────────────────────────────┐
│  🔒 沙箱环境预检 (LIMIT 100)    │  ← 您看到的"执行结果"
│                                 │
│  1. 语法检查                    │
│  2. 权限验证                    │
│  3. 质量探查                    │
│     - 缺失率检查                │
│     - 数据分布检查              │
│     - 异常值检测                │
└─────────────────────────────────┘
    ↓
预检通过 ✓
    ↓
用户决定：
  ├─ 选项1：执行全量数据（8432条）
  └─ 选项2：直接进入下一步（策略挖掘）
```

---

## 🔍 详细说明

### 1. 什么是沙箱测试？

**定义**：
- 在安全隔离的环境中，用**LIMIT 100**限制查询数据量
- 快速验证SQL代码的正确性和数据质量
- 避免全量数据查询造成的性能问题

**为什么要LIMIT 100？**
- ⚡ **快速验证**：100条数据足以发现代码问题
- 🛡️ **安全保护**：避免错误代码查询海量数据
- 💰 **成本控制**：减少数据库资源消耗
- 📊 **质量预估**：100条样本可以初步判断数据质量

---

### 2. 沙箱测试检查什么？

#### ✅ 检查项1：语法检查
```sql
-- 检查SQL语法是否正确
-- 如果有语法错误，会立即报错，不会执行
```

**示例**：
- ❌ 错误：`SELECT FROM user_table` （缺少字段）
- ✅ 正确：`SELECT * FROM user_table`

---

#### ✅ 检查项2：权限验证
```sql
-- 检查用户是否有权限访问该表
-- 如果没权限，会提示权限不足
```

**示例**：
- ❌ 错误：`SELECT * FROM sensitive_table` （无权限）
- ✅ 正确：`SELECT * FROM user_credit_table` （有权限）

---

#### ✅ 检查项3：数据质量探查

**3.1 缺失率检查**
```
查询100条数据后，自动计算每个字段的缺失率：
- age: 0% 缺失 ✓
- income: 2.3% 缺失 ✓ (可接受)
- phone: 15% 缺失 ⚠️ (需要处理)
```

**阈值设定**（PRD要求）：
- 缺失率 < 5%：✓ 优秀，可以直接使用
- 缺失率 5-20%：⚠️ 警告，需要决定处理方式
- 缺失率 > 20%：❌ 严重，建议不使用该字段

**3.2 数据分布检查**
```
- 检查数据是否有明显异常
- 检查是否有极端值
- 初步判断数据质量
```

---

### 3. 预检结果展示

#### 右侧代码页面显示：

```sql
SELECT 
    CASE 
        WHEN age BETWEEN 18 AND 25 THEN '18-25'
        WHEN age BETWEEN 26 AND 30 THEN '26-30'
        ...
    END AS age_group,
    COUNT(*) AS total_users,
    ...
FROM user_credit_table
WHERE create_time >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY age_group
ORDER BY overdue_rate DESC
LIMIT 100;  -- 🔒 沙箱模式：仅查询前100条数据进行预检
```

#### 执行结果显示：

```
┌─────────────────────────────────────┐
│ 🔒 沙箱测试结果 (LIMIT 100)         │
│                                     │
│ ✓ 预检通过                          │
├─────────────────────────────────────┤
│ 📌 沙箱机制说明：                   │
│ 为保证代码质量和系统安全，已在沙箱   │
│ 环境中执行LIMIT 100预检测试。        │
│                                     │
│ ✓ 语法检查：SQL语法正确              │
│ ✓ 权限检查：数据访问权限正常          │
│ ✓ 质量检查：数据缺失率2.3%            │
│                                     │
│ [执行全量数据] [查看质量报告]        │
├─────────────────────────────────────┤
│ 沙箱行数：100                        │
│ 执行时间：1.24s                      │
│ 缺失率：2.3%                         │
└─────────────────────────────────────┘
```

---

### 4. 用户的两个选择

#### 选择1：执行全量数据（推荐场景）

**什么时候选择？**
- ✅ 预检通过，需要完整数据
- ✅ 要进行精确的统计分析
- ✅ 要生成正式的策略报告

**点击"执行全量数据"后**：
```
1. 系统移除LIMIT 100限制
2. 执行完整查询（如8,432条）
3. 显示完整结果
4. 更新统计指标
```

**结果示例**：
```
✅ 全量查询完成！
📊 查询行数：8,432 条
⏱️ 执行时间：3.47秒
📈 数据完整性：97.7%
⚠️ 缺失字段：收入字段缺失 2.3%

💡 处理建议：
收入字段缺失率在可接受范围内（<5%），建议：
- 方案1：使用平均值填充
- 方案2：剔除缺失数据（推荐）
- 方案3：单独创建"收入未知"分箱

数据已准备就绪，可以进入下一步：策略挖掘 🔍
```

---

#### 选择2：直接进入下一步（快速场景）

**什么时候选择？**
- ✅ 只是探索性分析
- ✅ 100条样本数据已经够用
- ✅ 想快速看看趋势

**操作**：
```
1. 不点击"执行全量数据"
2. 直接点击左侧对话框的"继续下一步"
3. 进入"策略挖掘"环节
```

**说明**：
- 后续分析基于100条沙箱数据
- 适合快速原型验证
- 如果需要精确结果，随时可以回来执行全量

---

## 🎯 实际使用场景

### 场景1：完整策略开发（推荐）

**流程**：
```
步骤1：数据助手
  ├─ 输入查询需求
  ├─ 查看沙箱测试结果（100条）✓
  ├─ 点击"执行全量数据"
  └─ 获得完整数据（8,432条）✓

步骤2：策略挖掘
  ├─ 基于完整数据分析
  └─ 获得准确的IV值和分箱 ✓

步骤3：报告生成
  ├─ 基于完整数据回测
  └─ 生成正式报告 ✓
```

**优点**：
- ✅ 数据完整，分析准确
- ✅ 结果可靠，可以直接上线
- ✅ 适合正式的策略开发

---

### 场景2：快速探索分析

**流程**：
```
步骤1：数据助手
  ├─ 输入查询需求
  ├─ 查看沙箱测试结果（100条）✓
  └─ 直接进入下一步（不执行全量）

步骤2：策略挖掘
  ├─ 基于100条样本快速分析
  └─ 快速查看趋势 ✓

步骤3：报告生成
  ├─ 基于样本数据生成概览
  └─ 快速验证思路 ✓
```

**优点**：
- ✅ 速度快，几秒完成
- ✅ 适合探索和验证想法
- ✅ 节省计算资源

**缺点**：
- ⚠️ 样本可能不够代表性
- ⚠️ 统计指标可能不够准确
- ⚠️ 不适合直接上线

---

## 💡 设计理念

### 为什么要设计沙箱机制？

#### 1. 安全性
```
❌ 没有沙箱的风险：
- 错误SQL可能查询海量数据
- 可能导致数据库崩溃
- 可能泄露敏感数据

✅ 有沙箱的好处：
- 限制在100条，影响可控
- 快速发现问题
- 保护系统稳定性
```

---

#### 2. 效率性
```
❌ 直接全量查询：
- 可能需要等待数分钟
- 发现问题后需要重新查询
- 浪费大量时间

✅ 先沙箱后全量：
- 沙箱测试1-2秒完成
- 快速发现问题并修改
- 确认无误后再执行全量
```

---

#### 3. 成本性
```
❌ 每次都全量：
- 消耗大量数据库资源
- 增加成本
- 影响其他用户

✅ 沙箱+按需全量：
- 只在需要时才全量查询
- 节省资源
- 环保高效
```

---

## 📊 对比：沙箱 vs 全量

| 维度 | 沙箱测试 (LIMIT 100) | 全量查询 (8432条) |
|-----|---------------------|------------------|
| **查询时间** | 1-2秒 ⚡ | 3-5秒 |
| **数据量** | 100条 | 全部数据 |
| **用途** | 代码验证、质量检查 | 正式分析、生产报告 |
| **准确度** | 趋势参考 | 精确统计 |
| **资源消耗** | 低 💰 | 中 |
| **适用场景** | 探索、验证 | 正式开发 |
| **是否必须** | 是（强制） | 否（可选） |

---

## 🎬 实际演示

### 演示流程（2分钟）

**步骤1：触发沙箱测试**
```
1. 在数据助手中输入：
   "查询近30天内逾期超过7天的用户"
   
2. 等待2-3秒，右侧代码页面显示：
   - SQL代码（带LIMIT 100注释）
   - 沙箱测试结果
   - 数据质量指标
```

**步骤2：查看沙箱结果**
```
右侧显示：
┌────────────────────────────┐
│ 🔒 沙箱测试结果 (LIMIT 100) │
│ ✓ 预检通过                  │
│ 沙箱行数：100               │
│ 缺失率：2.3%                │
└────────────────────────────┘
```

**步骤3：决定下一步**
```
选项A：点击"执行全量数据" → 获取8,432条完整数据
选项B：点击"继续下一步" → 基于100条样本进入策略挖掘
```

---

## ❓ 常见问题

### Q1: 沙箱的100条数据是随机的吗？

**A**: 是的！通常是查询结果的前100条（ORDER BY之后）。这100条数据可以代表整体数据的特征和结构，用于验证代码正确性和初步质量检查。

---

### Q2: 如果沙箱测试失败会怎样？

**A**: 系统会立即提示错误，不会继续执行：
```
❌ 沙箱测试失败

错误类型：语法错误
错误信息：Column 'xxx' not found

[修改SQL] [查看帮助]
```

---

### Q3: 必须执行全量数据才能进入下一步吗？

**A**: 不是！您可以选择：
- **快速模式**：直接用100条沙箱数据进入下一步
- **完整模式**：执行全量后再进入下一步

两种都可以，根据需求选择。

---

### Q4: 执行全量后可以再次沙箱测试吗？

**A**: 可以！如果您修改了SQL代码，系统会重新进行沙箱测试。

---

### Q5: 沙箱机制可以关闭吗？

**A**: 不可以！这是强制的安全机制，确保代码质量和系统稳定性。

---

## 📚 相关PRD章节

这个设计来自PRD文档的：

**F1.2 智能数据预检 (沙箱机制)**
> 需求描述：代码在跑全量数据前，必须进行预测试与质量检查。
> 
> 功能细节：
> - 语法自检：生成代码后，系统先在沙箱环境运行（限制查询 100 条），确保无报错。
> - 质量探查：自动扫描结果集，若发现某关键字段缺失率超过阈值（如 20%），需主动弹窗提示用户确认处理方式（填充或剔除）。

---

## 🎯 总结

您的理解**完全正确**：

✅ **代码页面的执行结果** = 沙箱测试结果（LIMIT 100）  
✅ **这是脚本生成后的测试** = 是的，用于验证代码质量  
✅ **对话窗口提示下一步才进入下一环节** = 是的，或点击"执行全量数据"

**核心流程**：
```
生成SQL → 沙箱测试(100条) → 预检通过 → 
用户选择：
  A) 执行全量数据 → 完整分析
  B) 直接下一步 → 快速探索
```

这个设计既保证了**安全性**（沙箱预检），又提供了**灵活性**（可选全量），是一个非常合理的设计！

---

**文档版本**: V1.0  
**最后更新**: 2026-01-14  
**作者**: AI助手  
**感谢**: 用户的精准理解帮助我们完善了这个设计！
